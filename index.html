<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Work Tracker</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1976d2" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #121212;
      color: #ffffff;
      font-family: sans-serif;
      overflow: hidden;
    }

    h2 {
      text-align: center;
      color: #90caf9;
      margin-bottom: 0.5rem;
    }

    .tabs {
      display: flex;
      background-color: #1e1e1e;
    }

    .tab {
      flex: 1;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      background-color: #1e1e1e;
      color: #90caf9;
      font-weight: bold;
      border-bottom: 2px solid transparent;
    }

    .tab.active {
      border-bottom: 2px solid #90caf9;
    }

    .container {
      padding: 1rem;
    }

    .section {
      border: 1px solid #333;
      border-radius: 8px;
      padding: 1rem;
      background-color: #1e1e1e;
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.25rem;
    }

    input[type="time"],
    input[type="date"],
    input[type="month"] {
      width: 100%;
      padding: 0.5rem;
      background: #222;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }

    button {
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      margin-top: 0.5rem;
      cursor: pointer;
    }

    .time-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .output {
      text-align: center;
      font-weight: bold;
      margin-top: 0.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #222;
    }

    th, td {
      border: 1px solid #444;
      padding: 0.5rem;
      text-align: center;
    }

    #hoursTab, #calendarTab {
      display: none;
    }

    .active-tab {
      display: block;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      margin-top: 1rem;
    }

    .calendar-day {
      background-color: #1e1e1e;
      padding: 0.5rem;
      border: 1px solid #444;
      text-align: center;
      cursor: pointer;
    }

    .calendar-day.selected {
      background-color: #1976d2;
      color: white;
      font-weight: bold;
    }

    .week-num {
      background-color: #333;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('hours')">Hours</div>
    <div class="tab" onclick="switchTab('calendar')">Calendar</div>
  </div>

  <div class="container">
    <div id="hoursTab" class="active-tab">
      <h2>Work Entry</h2>

      <div class="section">
        <label for="start">Start time:</label>
        <div class="time-group">
          <input type="time" id="start" />
          <button onclick="setNow('start')">Now</button>
        </div>
        <div id="predictedExit" class="output"></div>
      </div>

      <div class="section">
        <label for="end">End time (optional):</label>
        <div class="time-group">
          <input type="time" id="end" />
          <button onclick="setNow('end')">Now</button>
        </div>
        <div id="overtimeResult" class="output"></div>
      </div>

      <div class="section">
        <label for="calendar">ðŸ“… Select date:</label>
        <input type="date" id="calendar" />
        <button onclick="saveDay()">Save Day</button>
        <button onclick="deleteDay()">Delete</button>
      </div>

      <div class="section">
        <label for="monthSelect">ðŸ“Š Monthly Summary:</label>
        <input type="month" id="monthSelect" onchange="generateSummary()" />
        <button onclick="exportToPDF()">Export PDF</button>
        <table id="summaryTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Start</th>
              <th>End</th>
              <th>Overtime</th>
              <th>Minutini</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="calendarTab">
      <h2>Calendar View</h2>
      <p style="text-align: center; font-size: 0.9rem;">(Minimal view with week numbers â€“ Monday to Sunday)</p>
      <!-- Placeholder: qui potrai integrare un calendario interattivo personalizzato -->
      <div class="calendar-grid">
        <div class="calendar-day week-num">Wk</div>
        <div class="calendar-day">Mon</div>
        <div class="calendar-day">Tue</div>
        <div class="calendar-day">Wed</div>
        <div class="calendar-day">Thu</div>
        <div class="calendar-day">Fri</div>
        <div class="calendar-day">Sat</div>
        <div class="calendar-day">Sun</div>
        <!-- Righe con giorni esempio -->
        <div class="calendar-day week-num">27</div>
        <div class="calendar-day">1</div>
        <div class="calendar-day">2</div>
        <div class="calendar-day">3</div>
        <div class="calendar-day">4</div>
        <div class="calendar-day">5</div>
        <div class="calendar-day">6</div>
        <div class="calendar-day">7</div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const setNow = (fieldId) => {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      document.getElementById(fieldId).value = `${hours}:${minutes}`;
      if (fieldId === 'start') calculateExit();
      if (fieldId === 'end') calculateOvertime();
    };

    const calculateExit = () => {
      const start = document.getElementById("start").value;
      if (!start) return;
      const [h, m] = start.split(":").map(Number);
      const exit = new Date();
      exit.setHours(h);
      exit.setMinutes(m + 45 + 8 * 60);
      const outH = exit.getHours().toString().padStart(2, '0');
      const outM = exit.getMinutes().toString().padStart(2, '0');
      document.getElementById("predictedExit").innerText = `Predicted exit: ${outH}:${outM}`;
    };

    const calculateOvertime = () => {
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      if (!start || !end) return;
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      const startMin = sh * 60 + sm;
      const endMin = eh * 60 + em;
      const workMin = endMin - startMin;
      const baseMin = 8 * 60 + 45;

      let overtime = 0;
      let minutini = 0;

      if (workMin > baseMin + 30) {
        overtime = Math.floor((workMin - baseMin - 30) / 15) * 15;
        minutini = (workMin - baseMin - 30) % 15;
      } else if (workMin > baseMin) {
        minutini = workMin - baseMin;
      }

      document.getElementById("overtimeResult").innerText =
        `Overtime: ${overtime} min | Minutini: ${minutini} min`;
    };

    const saveDay = () => {
      const date = document.getElementById("calendar").value;
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      if (!date || !start || !end) return;
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      const startMin = sh * 60 + sm;
      const endMin = eh * 60 + em;
      const baseMin = 8 * 60 + 45;

      let overtime = 0;
      let minutini = 0;
      const diff = endMin - startMin;

      if (diff > baseMin + 30) {
        overtime = Math.floor((diff - baseMin - 30) / 15) * 15;
        minutini = (diff - baseMin - 30) % 15;
      } else if (diff > baseMin) {
        minutini = diff - baseMin;
      }

      const data = {
        start,
        end,
        overtime,
        minutini
      };
      localStorage.setItem("day-" + date, JSON.stringify(data));
      alert("Saved!");
      generateSummary();
    };

    const deleteDay = () => {
      const date = document.getElementById("calendar").value;
      if (!date) return;
      localStorage.removeItem("day-" + date);
      alert("Deleted.");
      generateSummary();
    };

    const generateSummary = () => {
      const tbody = document.querySelector("#summaryTable tbody");
      tbody.innerHTML = "";
      const month = document.getElementById("monthSelect").value;
      if (!month) return;
      const [y, m] = month.split("-");
      const daysInMonth = new Date(y, m, 0).getDate();

      for (let d = 1; d <= daysInMonth; d++) {
        const day = `${y}-${m.padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
        const data = localStorage.getItem("day-" + day);
        if (data) {
          const { start, end, overtime, minutini } = JSON.parse(data);
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${day}</td>
            <td>${start}</td>
            <td>${end}</td>
            <td>${overtime}</td>
            <td>${minutini}</td>
          `;
          tbody.appendChild(row);
        }
      }
    };

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const table = document.getElementById("summaryTable");
      if (!table) {
        alert("No table found to export.");
        return;
      }

      let rows = [];
      const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.innerText);
      rows.push(headers);

      table.querySelectorAll("tbody tr").forEach(tr => {
        const row = Array.from(tr.querySelectorAll("td")).map(td => td.innerText);
        rows.push(row);
      });

      let y = 10;
      rows.forEach((row, idx) => {
        row.forEach((cell, i) => {
          doc.text(cell, 10 + i * 40, y);
        });
        y += 10;
      });

      const now = new Date();
      const filename = `WorkLog-${now.getFullYear()}-${String(now.getMonth()+1).padStart(2, '0')}.pdf`;
      doc.save(filename);
    }

    const switchTab = (tabName) => {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.active-tab').forEach(el => el.classList.remove('active-tab'));

      if (tabName === 'hours') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('hoursTab').classList.add('active-tab');
      } else {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('calendarTab').classList.add('active-tab');
      }
    };

    // Listener per aggiornamento automatico
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("start").addEventListener("change", calculateExit);
      document.getElementById("end").addEventListener("change", calculateOvertime);
    });
  </script>
</body>
</html>
