<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Work Tracker</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', sans-serif;
    }
    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 1rem;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      color: #64b5f6;
      margin-bottom: 1rem;
    }
    .section {
      margin-bottom: 1rem;
      border-top: 1px solid #444;
      padding-top: 1rem;
    }
    .input-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    input[type="time"] {
      flex: 1;
      padding: 0.4rem;
      background-color: #2c2c2c;
      border: 1px solid #555;
      color: #fff;
      border-radius: 4px;
    }
    button {
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .result, .calendar, .summary {
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 8px;
      overflow-y: auto;
      flex: 1;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 0.3rem;
      border-bottom: 1px solid #333;
      text-align: center;
    }
    select {
      background: #2c2c2c;
      color: #fff;
      border: 1px solid #555;
      padding: 0.4rem;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Work Tracker</h1>
    <div class="section">
      <label>Start Time:</label>
      <div class="input-row">
        <input type="time" id="startTime" onchange="autoCalculateExpectedEndTime()">
        <button onclick="setCurrentTime('startTime'); autoCalculateExpectedEndTime()">Now</button>
      </div>
    </div>
    <div class="section">
      <label>End Time:</label>
      <div class="input-row">
        <input type="time" id="endTime" onchange="calculateAndSave()">
        <button onclick="setCurrentTime('endTime'); calculateAndSave()">Now</button>
      </div>
    </div>
    <div class="result" id="result"></div>
    <div class="calendar" id="calendar"></div>
    <div class="summary">
      <select id="monthSelect" onchange="renderSummary()"></select>
      <div id="summaryTable"></div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
    }

    const resultEl = document.getElementById("result");
    const todayStr = new Date().toISOString().split('T')[0];

    function setCurrentTime(id) {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      document.getElementById(id).value = `${h}:${m}`;
    }

    function formatTime(date) {
      return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    function autoCalculateExpectedEndTime() {
      const val = document.getElementById("startTime").value;
      if (!val) return;
      const [h, m] = val.split(":").map(Number);
      const start = new Date();
      start.setHours(h, m, 0, 0);
      const end = new Date(start);
      end.setMinutes(end.getMinutes() + 525);
      resultEl.innerHTML = `<strong>Expected end:</strong> ${formatTime(end)}`;
      calculateAndSave();
    }

    function calculateAndSave() {
      const startVal = document.getElementById("startTime").value;
      const endVal = document.getElementById("endTime").value;
      if (!startVal || !endVal) return;

      const [sh, sm] = startVal.split(":"), [eh, em] = endVal.split(":");
      const start = new Date(), end = new Date();
      start.setHours(+sh, +sm, 0, 0);
      end.setHours(+eh, +em, 0, 0);

      const expected = new Date(start);
      expected.setMinutes(start.getMinutes() + 525);
      let diff = Math.floor((end - expected) / 60000);

      let overtime = 0, minutini = 0;
      if (diff > 0) {
        if (diff >= 30) {
          overtime = 30 + Math.floor((diff - 30) / 15) * 15;
          minutini = (diff - 30) % 15;
        } else {
          minutini = diff;
        }
      }

      const dayKey = new Date().toISOString().split("T")[0];
      const data = {
        date: dayKey,
        start: startVal,
        end: endVal,
        overtime,
        minutini
      };

      const store = JSON.parse(localStorage.getItem("workdays") || "{}");
      store[dayKey] = data;
      localStorage.setItem("workdays", JSON.stringify(store));

      resultEl.innerHTML =
        `<strong>Expected end:</strong> ${formatTime(expected)}<br>` +
        `<strong>Overtime:</strong> ${overtime} min<br>` +
        `<strong>Minutini:</strong> ${minutini} min`;

      renderCalendar();
      renderSummary();
    }

    function renderCalendar() {
      const store = JSON.parse(localStorage.getItem("workdays") || "{}");
      const keys = Object.keys(store).sort().reverse();
      const cal = document.getElementById("calendar");
      cal.innerHTML = `<h3>Daily Logs</h3>`;
      keys.forEach(k => {
        const d = store[k];
        cal.innerHTML += `${k}: ${d.start} - ${d.end} | OT: ${d.overtime} | M: ${d.minutini}<br>`;
      });
    }

    function renderSummary() {
      const store = JSON.parse(localStorage.getItem("workdays") || "{}");
      const summary = document.getElementById("summaryTable");
      const monthSelect = document.getElementById("monthSelect");
      const months = [...new Set(Object.keys(store).map(k => k.slice(0, 7)))];

      monthSelect.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join("");
      const selected = monthSelect.value;
      let rows = Object.entries(store).filter(([k]) => k.startsWith(selected));

      let totalOT = 0, totalMinutini = 0;
      let table = `<table><tr><th>Date</th><th>In</th><th>Out</th><th>OT</th><th>Min</th></tr>`;
      rows.forEach(([date, d]) => {
        totalOT += d.overtime;
        totalMinutini += d.minutini;
        table += `<tr><td>${date}</td><td>${d.start}</td><td>${d.end}</td><td>${d.overtime}</td><td>${d.minutini}</td></tr>`;
      });
      table += `<tr><th colspan=3>Total</th><th>${totalOT}</th><th>${totalMinutini}</th></tr></table>`;
      summary.innerHTML = table;
    }

    // Inizializzazione
    renderCalendar();
    setTimeout(renderSummary, 50);
  </script>
</body>
</html>
