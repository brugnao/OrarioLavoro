<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="manifest" href="manifest.json" />
  <title>Work Tracker</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #fff;
      overflow: hidden;
    }

    h1 {
      text-align: center;
      color: #2196f3;
      margin: 1em 0 0.5em;
    }

    .tab-container {
      display: flex;
      justify-content: center;
      background-color: #1e1e1e;
    }

    .tab-button {
      background-color: #1976d2;
      border: none;
      color: white;
      padding: 0.6em 1.2em;
      margin: 0.3em;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
    }

    .tab-button.active {
      background-color: #2196f3;
    }

    .tab-content {
      padding: 1em;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .section {
      text-align: center;
      margin: 1em auto;
    }

    label, input, button {
      display: inline-block;
      margin: 0.3em;
      font-size: 1em;
    }

    input[type="time"] {
      padding: 0.2em;
      background-color: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
    }

    .result {
      font-weight: bold;
      text-align: center;
      margin-top: 1em;
    }

    button.now-btn {
      background-color: #2196f3;
      color: white;
      border: none;
      padding: 0.3em 0.6em;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 0.5em;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff;
      margin: 1em 0;
    }

    #calendar-table {
      width: 100%;
      border-collapse: collapse;
      color: #fff;
    }

    #calendar-table th, #calendar-table td {
      border: 1px solid #333;
      text-align: center;
      padding: 0.6em;
      cursor: pointer;
    }

    #calendar-table td.selected {
      background-color: #1976d2;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>Work Tracker</h1>

<div class="tab-container">
  <button class="tab-button active" onclick="openTab('hours')">Hours</button>
  <button class="tab-button" onclick="openTab('calendar')">Calendar</button>
</div>

<div id="hours" class="tab-content active">
  <div class="section">
    <label>Check-in:</label>
    <input type="time" id="checkIn" />
    <button class="now-btn" onclick="setNow('checkIn')">Now</button>
  </div>

  <div class="section">
    <label>Actual Check-out (optional):</label>
    <input type="time" id="checkOut" />
    <button class="now-btn" onclick="setNow('checkOut')">Now</button>
  </div>

  <div class="result" id="expectedOut"></div>
  <div class="result" id="extraResult"></div>
</div>

<div id="calendar" class="tab-content">
  <div class="calendar-header">
    <button onclick="changeMonth(-1)">❮</button>
    <span id="calendar-month"></span>
    <button onclick="changeMonth(1)">❯</button>
  </div>
  <table id="calendar-table"></table>
  <div class="section" style="margin-top:1em;">
    <h3 id="selected-date-title">Select a date</h3>
    <label>Check-in: <input type="time" id="calendarCheckIn"></label>
    <label>Check-out: <input type="time" id="calendarCheckOut"></label>
    <button onclick="saveCalendarEntry()">Save</button>
  </div>
</div>

<script>
  function openTab(tabId) {
    document.querySelectorAll(".tab-content").forEach(div => div.classList.remove("active"));
    document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
    document.getElementById(tabId).classList.add("active");
    document.querySelector(`[onclick="openTab('${tabId}')"]`).classList.add("active");

    if (tabId === 'calendar') renderCalendar();
  }

  function setNow(id) {
    const now = new Date();
    document.getElementById(id).value = now.toTimeString().slice(0,5);
    if (id === 'checkIn') updateExpectedOut();
    if (id === 'checkOut') calculateExtras();
  }

  document.getElementById('checkIn').addEventListener('input', updateExpectedOut);
  document.getElementById('checkOut').addEventListener('input', calculateExtras);

  function updateExpectedOut() {
    const checkIn = document.getElementById('checkIn').value;
    if (!checkIn) return;

    const [h, m] = checkIn.split(':').map(Number);
    const out = new Date();
    out.setHours(h, m + 45 + 8 * 60);
    document.getElementById('expectedOut').textContent = `Expected check-out: ${out.toTimeString().slice(0,5)}`;
    calculateExtras();
  }

  function calculateExtras() {
    const checkIn = document.getElementById('checkIn').value;
    const checkOut = document.getElementById('checkOut').value;
    if (!checkIn || !checkOut) return;

    const [h1, m1] = checkIn.split(':').map(Number);
    const [h2, m2] = checkOut.split(':').map(Number);
    const inMin = h1 * 60 + m1;
    const outMin = h2 * 60 + m2;
    const total = outMin - inMin;
    const expected = 8 * 60 + 45;

    let extra = total - expected;
    let ot = 0;
    let partial = 0;

    if (extra >= 30) {
      ot = Math.floor((extra - 30) / 15) * 15;
      partial = (extra - 30) % 15;
      extra = 30;
    } else if (extra > 0) {
      partial = extra;
      extra = 0;
    }

    document.getElementById('extraResult').textContent = `Overtime: ${extra + ot} min — Small mins: ${partial} min`;
  }

  // Calendar
  let currentMonth = new Date();

  function renderCalendar() {
    const table = document.getElementById("calendar-table");
    const monthLabel = document.getElementById("calendar-month");
    table.innerHTML = "";

    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = (firstDay.getDay() + 6) % 7;
    const totalDays = lastDay.getDate();

    monthLabel.textContent = currentMonth.toLocaleDateString("en-US", { month: 'long', year: 'numeric' });

    const headerRow = document.createElement("tr");
    ["Wk", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach(d => {
      const th = document.createElement("th");
      th.textContent = d;
      headerRow.appendChild(th);
    });
    table.appendChild(headerRow);

    let day = 1;
    let week = getWeekNumber(new Date(year, month, 1));

    while (day <= totalDays) {
      const row = document.createElement("tr");
      const weekCell = document.createElement("td");
      weekCell.textContent = week++;
      row.appendChild(weekCell);

      for (let i = 0; i < 7; i++) {
        const td = document.createElement("td");
        if ((day === 1 && i < startDay) || day > totalDays) {
          td.textContent = "";
        } else {
          td.textContent = day;
          td.onclick = () => selectCalendarDate(year, month, day);
          day++;
        }
        row.appendChild(td);
      }
      table.appendChild(row);
    }
  }

  function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  }

  let selectedCalendarDate = null;

  function selectCalendarDate(y, m, d) {
    const dateStr = `${y}-${String(m+1).padStart(2, "0")}-${String(d).padStart(2,"0")}`;
    selectedCalendarDate = dateStr;
    document.getElementById("selected-date-title").textContent = `Selected: ${dateStr}`;
    const saved = JSON.parse(localStorage.getItem("calendarData") || "{}")[dateStr] || {};
    document.getElementById("calendarCheckIn").value = saved.in || "";
    document.getElementById("calendarCheckOut").value = saved.out || "";

    document.querySelectorAll("#calendar-table td").forEach(td => td.classList.remove("selected"));
    [...document.querySelectorAll("#calendar-table td")].forEach(td => {
      if (td.textContent === String(d)) td.classList.add("selected");
    });
  }

  function saveCalendarEntry() {
    if (!selectedCalendarDate) return;
    const checkIn = document.getElementById("calendarCheckIn").value;
    const checkOut = document.getElementById("calendarCheckOut").value;
    const data = JSON.parse(localStorage.getItem("calendarData") || "{}");
    data[selectedCalendarDate] = { in: checkIn, out: checkOut };
    localStorage.setItem("calendarData", JSON.stringify(data));
    alert("Saved!");
  }

  function changeMonth(delta) {
    currentMonth.setMonth(currentMonth.getMonth() + delta);
    renderCalendar();
  }

  // Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register("sw.js").then(() => console.log("SW registered"));
  }
</script>

</body>
</html>
